<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Human Performance Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <!-- 
    Application Update:
    - Adjusted main menu layout to stack the "Start Test Session" button content vertically.
    - Updated main menu text to dynamically show "first," "second," or "final" session.
    -->
    <style>
        html {
            overscroll-behavior-y: contain;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBFA;
            color: #4A4540;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            overscroll-behavior-y: contain;
        }
        .screen {
            display: none;
            width: 100%;
            min-height: 100vh;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .active {
            display: flex;
        }
        .btn {
            @apply px-8 py-3 bg-[#E7E0D8] text-[#4A4540] font-semibold rounded-lg shadow-md hover:bg-[#D7CEC5] transition-all duration-200 ease-in-out transform hover:-translate-y-0.5 active:translate-y-0 active:shadow-inner border border-[#D7CEC5] focus:outline-none focus:ring-2 focus:ring-[#6750A4] focus:ring-offset-2;
        }
        .btn:disabled {
            @apply bg-gray-300 text-gray-500 cursor-not-allowed transform-none shadow-inner;
        }
        .btn-primary {
            @apply bg-[#6750A4] text-white hover:bg-[#5A4491] border-transparent;
        }
        .btn-primary:disabled {
            @apply bg-gray-400 hover:bg-gray-400;
        }

        .menu-card {
            @apply flex flex-col items-center justify-center p-6 bg-white rounded-xl shadow-lg border-2 border-transparent hover:border-[#6750A4] hover:shadow-xl transition-all duration-300 ease-in-out transform hover:-translate-y-1 cursor-pointer text-center;
        }
        
        #aim-area {
            width: 90vw;
            height: 70vh;
            max-width: 1000px;
            max-height: 600px;
            background-color: #F1ECE6;
            border: 2px solid #D7CEC5;
            position: relative;
            cursor: crosshair;
            overflow: hidden;
            border-radius: 8px;
        }
        #aim-target {
            width: 5cm;
            height: 5cm;
            position: absolute;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }
        #aim-target > div {
            border-radius: 50%;
            position: absolute;
        }
        #target-outer { width: 5cm; height: 5cm; background-color: #B5322F; border: 2px solid #FDFBFA; }
        #target-middle { width: 3cm; height: 3cm; background-color: white; }
        #target-inner { width: 1cm; height: 1cm; background-color: #B5322F; }

        #jigsaw-embed-container {
            background-color: #E7E0D8;
        }
        #jigsaw-embed-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .input-error {
            @apply border-red-500 ring-1 ring-red-400;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Screen: Welcome -->
    <div id="welcome-screen" class="screen active p-4">
        <div class="text-center bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h1 class="text-4xl font-bold text-[#6750A4]">Performance Tester</h1>
            <p class="mt-4 text-lg text-gray-600">Enter your details to begin.</p>
            <input id="name-input" type="text" placeholder="Your Name" class="mt-8 w-full px-4 py-3 border border-[#D7CEC5] rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-[#6750A4]">
            <select id="lang-select" class="mt-4 w-full px-4 py-3 border border-[#D7CEC5] rounded-lg text-lg bg-white focus:outline-none focus:ring-2 focus:ring-[#6750A4]">
                <option value="" disabled selected>Select a Language</option>
                <option value="En">English</option>
                <option value="Hi">Hindi</option>
                <option value="Ml">Malayalam</option>
                <option value="Es">Spanish</option>
            </select>
            <select id="group-select" class="mt-4 w-full px-4 py-3 border border-[#D7CEC5] rounded-lg text-lg bg-white focus:outline-none focus:ring-2 focus:ring-[#6750A4]">
                <option value="" disabled selected>Select a Group</option>
                <option value="A">Group A</option>
                <option value="B">Group B</option>
                <option value="C">Group C</option>
                <option value="D">Group D</option>
                <option value="E">Group E</option>
                <option value="F">Group F</option>
            </select>
            <button id="start-btn" class="btn mt-6 w-full text-lg flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold"><span class="material-symbols-outlined mr-2">arrow_forward</span>Start</button>
        </div>
    </div>

    <!-- Screen: Main Menu -->
    <div id="menu-screen" class="screen p-4">
        <div class="text-center w-full max-w-3xl">
            <div class="absolute top-4 right-4 bg-gray-100 px-3 py-1 rounded-full text-lg font-semibold">
                Session: <span id="session-counter">0 / 3</span>
            </div>
            <h2 class="text-3xl font-bold">Welcome, <span id="user-name-display"></span>!</h2>
            <p id="session-prompt" class="mt-2 text-xl text-gray-600"></p>
            <div class="mt-10 flex justify-center">
                 <button id="start-tests-btn" class="flex flex-col items-center justify-center p-6 rounded-xl shadow-lg transition-all duration-300 ease-in-out transform hover:-translate-y-1 cursor-pointer text-center max-w-sm mx-auto bg-blue-600 hover:bg-blue-700 text-white">
                    <span class="text-5xl">ðŸš€</span>
                    <h3 class="text-xl font-bold mt-2">Start Test Session</h3>
                    <p class="text-sm mt-1 opacity-90">This will begin with a puzzle.</p>
                </button>
            </div>
            <p id="tests-complete-msg" class="text-green-600 font-semibold mt-4 text-lg hidden">All test sessions complete!</p>
            <div class="mt-12 flex flex-col sm:flex-row justify-center items-center gap-4">
                 <button id="view-results-btn" class="btn">View My Results</button>
                 <button id="download-all-btn" class="btn">Download All Data</button>
            </div>
        </div>
    </div>
    
    <!-- Screen: Pre-Test Countdown -->
    <div id="pre-test-countdown-screen" class="screen p-4 flex-col bg-gray-800 text-white">
        <h2 class="text-4xl font-bold mb-4">Get Ready...</h2>
        <div id="pre-test-timer" class="text-9xl font-bold">15</div>
    </div>

    <!-- Screen: Aim Trainer -->
    <div id="aim-trainer-screen" class="screen p-4 flex-col">
        <div class="w-full max-w-4xl flex justify-between items-center mb-2 px-2">
            <div class="w-36"></div>
            <h3 class="text-2xl font-bold">Aim Trainer</h3>
            <p class="text-lg font-mono">Target: <span id="target-count">0 / 0</span></p>
        </div>
        <div id="aim-test-ui" class="text-center w-full max-w-4xl flex-grow flex items-center justify-center">
            <div id="aim-area">
                <div id="aim-target">
                    <div id="target-outer" data-score="1"></div>
                    <div id="target-middle" data-score="2"></div>
                    <div id="target-inner" data-score="3"></div>
                </div>
                 <div id="aim-start-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-50 flex flex-col justify-center items-center text-white p-4">
                    <div id="aim-overlay-initial-content" class="text-center">
                        <h4 class="text-3xl font-bold">Click 30 targets as fast as you can.</h4>
                        <button id="start-aim-test-btn" class="mt-6 btn flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold"><span class="material-symbols-outlined mr-2">arrow_forward</span>Start Test</button>
                    </div>
                    <div id="aim-countdown-container" class="hidden">
                        <h1 id="aim-countdown" class="text-9xl font-bold text-white"></h1>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen: Number Memory -->
    <div id="number-memory-screen" class="screen p-4 flex-col justify-start">
         <div class="w-full max-w-3xl flex justify-start items-center p-2">
            <div class="w-36"></div>
        </div>
        <div id="memory-test-ui" class="text-center w-full max-w-3xl">
            <input type="tel" id="keyboard-activator" class="absolute -top-96 -left-96">
            <h3 class="text-2xl font-bold">Number Memory Test</h3>
            <p class="text-lg font-mono mt-2">Round: <span id="round-count">1 / 5</span></p>
            <div id="memory-display-container" class="relative mt-8 bg-white rounded-lg min-h-[80px] w-full p-6 cursor-text">
                <div id="number-display-area" class="absolute inset-0 flex items-center justify-center text-4xl md:text-5xl font-mono tracking-widest whitespace-nowrap"></div>
                <div id="otp-input-area" class="absolute inset-0 hidden flex flex-nowrap items-center justify-center gap-2 p-2"></div>
            </div>
            <div id="timer-dots" class="flex justify-center gap-4 mt-4 h-4 invisible">
                <div class="timer-dot w-3 h-3 bg-gray-400 rounded-full transition-opacity duration-300"></div>
                <div class="timer-dot w-3 h-3 bg-gray-400 rounded-full transition-opacity duration-300"></div>
                <div class="timer-dot w-3 h-3 bg-gray-400 rounded-full transition-opacity duration-300"></div>
            </div>
            <div><p class="mt-2">Press Space to skip a digit, Enter to submit.</p></div>
              <div id="memory-start-overlay" class="mt-8 flex flex-col items-center">
                <h4 class="text-2xl font-bold">Memorize the sequence of numbers.</h4>
                <button id="start-memory-test-btn" class="mt-6 btn flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold"><span class="material-symbols-outlined mr-2">arrow_forward</span>Start Test</button>
            </div>
        </div>
    </div>

    <!-- Screen: Jigsaw Puzzle -->
    <div id="jigsaw-screen" class="screen flex-col h-screen">
        <div class="w-full flex justify-between items-center p-2 sm:p-4 z-10 bg-white/20 backdrop-blur-sm flex-shrink-0">
            <button id="jigsaw-back-btn" class="btn !px-4 !py-2 flex items-center bg-blue-600 text-white font-bold rounded-lg shadow-md"><span class="material-symbols-outlined mr-2">arrow_forward</span>Continue to Tests</button>
            <h2 class="text-xl sm:text-2xl font-bold">Jigsaw Puzzle</h2>
            <div class="w-36"></div> <!-- Spacer -->
        </div>
        <div id="jigsaw-embed-container" class="flex-grow w-full"></div>
    </div>

    <!-- Screen: Results -->
    <div id="results-screen" class="screen p-4 md:p-8">
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-4xl">
            <h2 class="text-3xl font-bold text-center">Results</h2>
            <div id="results-content" class="mt-6 space-y-4 max-h-[70vh] overflow-y-auto"></div>
            <div class="text-center mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="back-to-menu-btn" class="btn w-full sm:w-auto">Back to Menu</button>
                <button id="download-csv-btn" class="btn btn-primary w-full sm:w-auto">Download My Data (CSV)</button>
            </div>
        </div>
    </div>
    
    <audio id="background-music" loop></audio>

    <script>
        'use strict';
        const AppConfig = {
            AIM_TARGET_COUNT: 30,
            MEMORY_ROUNDS: 5,
            MEMORY_DIGIT_INCREMENT: 3,
            MEMORY_STARTING_DIGITS: 3,
            MEMORY_BASE_DISPLAY_TIME: 2000,
            MEMORY_TIME_PER_DIGIT: 1000,
        };

        const state = {
            userName: '',
            lang: '',
            group: '',
            sessionCount: 0,
            currentTest: null,
            aimTestResults: [],
            memoryTestResults: [],
            currentMusicCondition: '',
            currentMusicLang: '',
            inTestSession: false,
        };

        const screens = {
            welcome: document.getElementById('welcome-screen'),
            menu: document.getElementById('menu-screen'),
            preTestCountdown: document.getElementById('pre-test-countdown-screen'),
            aim: document.getElementById('aim-trainer-screen'),
            memory: document.getElementById('number-memory-screen'),
            jigsaw: document.getElementById('jigsaw-screen'),
            results: document.getElementById('results-screen'),
        };

        const ui = {
            nameInput: document.getElementById('name-input'),
            langSelect: document.getElementById('lang-select'),
            groupSelect: document.getElementById('group-select'),
            startBtn: document.getElementById('start-btn'),
            userNameDisplay: document.getElementById('user-name-display'),
            sessionCounter: document.getElementById('session-counter'),
            sessionPrompt: document.getElementById('session-prompt'),
            startTestsBtn: document.getElementById('start-tests-btn'),
            testsCompleteMsg: document.getElementById('tests-complete-msg'),
            viewResultsBtn: document.getElementById('view-results-btn'),
            backToMenuBtn: document.getElementById('back-to-menu-btn'),
            resultsContent: document.getElementById('results-content'),
            downloadCsvBtn: document.getElementById('download-csv-btn'),
            downloadAllBtn: document.getElementById('download-all-btn'),
            preTestTimer: document.getElementById('pre-test-timer'),
        };

        const aimUI = {
            area: document.getElementById('aim-area'),
            target: document.getElementById('aim-target'),
            countDisplay: document.getElementById('target-count'),
            startOverlay: document.getElementById('aim-start-overlay'),
            startTestBtn: document.getElementById('start-aim-test-btn'),
            overlayInitialContent: document.getElementById('aim-overlay-initial-content'),
            countdownContainer: document.getElementById('aim-countdown-container'),
            countdown: document.getElementById('aim-countdown'),
        };
        
        const memoryUI = {
            roundDisplay: document.getElementById('round-count'),
            numberDisplay: document.getElementById('number-display-area'),
            timerDots: document.getElementById('timer-dots'),
            otpInputArea: document.getElementById('otp-input-area'),
            startOverlay: document.getElementById('memory-start-overlay'),
            startTestBtn: document.getElementById('start-memory-test-btn'),
            memoryDisplayContainer: document.getElementById('memory-display-container'),
            keyboardActivator: document.getElementById('keyboard-activator'),
        };

        const jigsawUI = {
            backBtn: document.getElementById('jigsaw-back-btn'),
            embedContainer: document.getElementById('jigsaw-embed-container'),
        };

        const musicPlayer = document.getElementById('background-music');

        let db;

        const JIGSAW_EMBEDS = [
            "https://puzzleme.amuselabs.com/pmm/jigsaw?id=b9a74334&set=e5be2f29555f0b9157d1936275ff5b69cee8c5c5198c9d48b300dca4f0df5a7f&embed=1",
            "https://puzzleme.amuselabs.com/pmm/jigsaw?id=e3ca82a8&set=e5be2f29555f0b9157d1936275ff5b69cee8c5c5198c9d48b300dca4f0df5a7f&embed=1",
            "https://puzzleme.amuselabs.com/pmm/jigsaw?id=73f650df&set=e5be2f29555f0b9157d1936275ff5b69cee8c5c5198c9d48b300dca4f0df5a7f&embed=1"
        ];

        const MUSIC_CONDITIONS = {
            A: ['S', 'N', 'P'], B: ['S', 'P', 'N'], C: ['N', 'S', 'P'],
            D: ['N', 'P', 'S'], E: ['P', 'N', 'S'], F: ['P', 'S', 'N']
        };

        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenId].classList.add('active');
        }

        const Music = {
            play: function(lang) {
                if (!lang || lang === 'Silence') {
                    musicPlayer.src = 'Silent.mp3';
                    musicPlayer.play().catch(() => console.log("Silent.mp3 not found or autoplay prevented."));
                    return;
                }
                const fileName = `${lang}.mp3`;
                musicPlayer.src = fileName;
                const promise = musicPlayer.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        console.log(`Music autoplay for ${fileName} was prevented.`);
                    });
                }
            },
            stop: function() {
                musicPlayer.pause();
                musicPlayer.currentTime = 0;
            }
        };

        const Database = {
            init: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('HumanPerformanceDB', 1);
                    request.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('results')) db.createObjectStore('results', { keyPath: 'id', autoIncrement: true });
                    };
                    request.onsuccess = e => { db = e.target.result; resolve(); };
                    request.onerror = e => reject('DB Error: ' + e.target.error);
                });
            },
            saveResult: function(resultData) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['results'], 'readwrite');
                    const store = transaction.objectStore('results');
                    const request = store.add(resultData);
                    request.onsuccess = () => resolve();
                    request.onerror = e => reject('Save Error: ' + e.target.error);
                });
            },
            getResults: function(userName, lang, group) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['results'], 'readonly');
                    const store = transaction.objectStore('results');
                    const allResults = [];
                    const request = store.openCursor();
                    request.onsuccess = e => {
                        const cursor = e.target.result;
                        if (cursor) {
                            if (cursor.value.userName === userName && cursor.value.language === lang && cursor.value.group === group) {
                                allResults.push(cursor.value);
                            }
                            cursor.continue();
                        } else resolve(allResults.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)));
                    };
                    request.onerror = e => reject('Fetch Error: ' + e.target.error);
                });
            },
             getAllResults: function() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['results'], 'readonly');
                    const store = transaction.objectStore('results');
                    const request = store.getAll();
                    request.onsuccess = e => resolve(e.target.result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
                    request.onerror = e => reject('Fetch Error: ' + e.target.error);
                });
            }
        };

        function setupEventListeners() {
            ui.startBtn.addEventListener('click', handleStart);
            ['nameInput', 'langSelect', 'groupSelect'].forEach(id => {
                ui[id].addEventListener('input', () => ui[id].classList.remove('input-error'));
            });
            ui.startTestsBtn.addEventListener('click', () => startTestSession());
            aimUI.startTestBtn.addEventListener('click', runAimTest);
            memoryUI.startTestBtn.addEventListener('click', runMemoryTest);
            aimUI.target.addEventListener('click', handleTargetHit);
            aimUI.area.addEventListener('click', handleTargetMiss);
            ui.backToMenuBtn.addEventListener('click', () => showScreen('menu'));
            ui.viewResultsBtn.addEventListener('click', showAllResults);
            ui.downloadCsvBtn.addEventListener('click', downloadMyCsv);
            ui.downloadAllBtn.addEventListener('click', downloadAllUserDataCsv);
            memoryUI.memoryDisplayContainer.addEventListener('click', handleMemoryContainerClick);
            
            jigsawUI.backBtn.addEventListener('click', () => {
                jigsawUI.embedContainer.innerHTML = '';
                if (state.inTestSession) {
                    startPreTestCountdown();
                } else {
                    showScreen('menu');
                }
            });
        }

        async function handleStart() {
            const name = ui.nameInput.value.trim();
            const lang = ui.langSelect.value;
            const group = ui.groupSelect.value;
            let isValid = true;

            if (!name) { ui.nameInput.classList.add('input-error'); isValid = false; }
            if (!lang) { ui.langSelect.classList.add('input-error'); isValid = false; }
            if (!group) { ui.groupSelect.classList.add('input-error'); isValid = false; }

            if (isValid) {
                state.userName = name;
                state.lang = lang;
                state.group = group;
                ui.userNameDisplay.textContent = state.userName;

                const existingResults = await Database.getResults(state.userName, state.lang, state.group);
                const aimSessions = existingResults.filter(r => r.testType === 'aim').length;
                state.sessionCount = aimSessions;
                updateSessionCounter();
                
                showScreen('menu');
            }
        }
        
        function updateSessionCounter() {
             ui.sessionCounter.textContent = `${state.sessionCount} / 3`;
             const prompts = ["Ready for your first session?", "Ready for your second session?", "Ready for your final session?"];
             
             if (state.sessionCount < 3) {
                 ui.sessionPrompt.textContent = prompts[state.sessionCount];
                 ui.startTestsBtn.disabled = false;
                 ui.testsCompleteMsg.classList.add('hidden');
                 ui.startTestsBtn.style.display = 'flex';
             } else {
                 ui.sessionPrompt.textContent = "All sessions are complete.";
                 ui.startTestsBtn.disabled = true;
                 ui.testsCompleteMsg.classList.remove('hidden');
                 ui.startTestsBtn.style.display = 'none';
             }
        }

        function handleMemoryContainerClick(e) {
            if (e.target.tagName === 'INPUT') return;
            if (!memoryUI.otpInputArea.classList.contains('hidden')) {
                const inputs = [...memoryUI.otpInputArea.children].filter(el => el.tagName === 'INPUT');
                if (inputs.length === 0) return;
                const firstEmptyInput = inputs.find(input => input.value === '');
                if (firstEmptyInput) firstEmptyInput.focus();
                else inputs[inputs.length - 1].focus();
            } else if (!memoryUI.numberDisplay.classList.contains('hidden')) {
                memoryUI.keyboardActivator.focus();
            }
        }

        function determineMusic() {
            const conditionOrder = MUSIC_CONDITIONS[state.group];
            if (!conditionOrder) return { condition: 'S', lang: 'Silence' };
            
            const condition = conditionOrder[state.sessionCount];
            let musicLang = 'Silence';

            if (condition === 'P') {
                musicLang = state.lang;
            } else if (condition === 'N') {
                if (state.lang === 'Hi') musicLang = 'Ml';
                else if (state.lang === 'En') musicLang = 'Es';
                else if (state.lang === 'Ml') musicLang = 'Hi';
                else if (state.lang === 'Es') musicLang = 'En';
            }
            state.currentMusicCondition = condition;
            state.currentMusicLang = musicLang;
        }
        
        function startTestSession() {
            state.inTestSession = true;
            startJigsawTest(false);
        }

        function startPreTestCountdown() {
            determineMusic();
            showScreen('preTestCountdown');
            let timer = 15;
            ui.preTestTimer.textContent = timer;
            Music.play(state.currentMusicLang);

            const interval = setInterval(() => {
                timer--;
                ui.preTestTimer.textContent = timer;
                if (timer <= 0) {
                    clearInterval(interval);
                    startAimTest();
                }
            }, 1000);
        }

        // --- Aim Trainer Functions ---
        let targetClickTime = 0;
        function startAimTest() {
            state.currentTest = 'aim';
            showScreen('aim');
            aimUI.startOverlay.style.display = 'flex';
            aimUI.overlayInitialContent.style.display = 'block';
            aimUI.countdownContainer.style.display = 'none';
            aimUI.target.style.display = 'none';
            aimUI.countDisplay.textContent = `0 / ${AppConfig.AIM_TARGET_COUNT}`;
        }
        
        function runAimTest(){
            aimUI.startOverlay.style.display = 'flex';
            aimUI.overlayInitialContent.style.display = 'none';
            aimUI.countdownContainer.style.display = 'block';
            let count = 3;
            aimUI.countdown.textContent = count;
            const interval = setInterval(() => {
                count--;
                if (count > 0) aimUI.countdown.textContent = count;
                else {
                    clearInterval(interval);
                    aimUI.startOverlay.style.display = 'none';
                    state.aimTestResults = [];
                    aimUI.countDisplay.textContent = `1 / ${AppConfig.AIM_TARGET_COUNT}`;
                    spawnTarget();
                }
            }, 1000);
        }

        function spawnTarget() {
            aimUI.target.style.display = 'flex';
            const areaRect = aimUI.area.getBoundingClientRect();
            const targetSize = aimUI.target.offsetWidth;
            const maxX = areaRect.width - targetSize, maxY = areaRect.height - targetSize;
            const x = Math.random() * (maxX > 0 ? maxX : 0);
            const y = Math.random() * (maxY > 0 ? maxY : 0);
            aimUI.target.style.left = `${x}px`;
            aimUI.target.style.top = `${y}px`;
            targetClickTime = Date.now();
        }

        function handleTargetHit(e) {
            e.stopPropagation();
            const timeTaken = Date.now() - targetClickTime;
            const accuracyScore = parseInt(e.target.dataset.score || 0);
            state.aimTestResults.push({ speed: timeTaken, accuracy: accuracyScore });
            checkAimTestEnd();
        }

        function handleTargetMiss(e) {
            if (e.target === aimUI.area) {
                const timeTaken = Date.now() - targetClickTime;
                state.aimTestResults.push({ speed: timeTaken, accuracy: 0 });
                checkAimTestEnd();
            }
        }

        function checkAimTestEnd() {
            if (state.aimTestResults.length < AppConfig.AIM_TARGET_COUNT) {
                aimUI.countDisplay.textContent = `${state.aimTestResults.length + 1} / ${AppConfig.AIM_TARGET_COUNT}`;
                spawnTarget();
            } else endTest();
        }
        
        // --- Memory Test Functions ---
        let currentMemoryRound = 0, currentNumber = '', memoryStartTime = 0;

        function startMemoryTest() {
            state.currentTest = 'memory';
            showScreen('memory');
            memoryUI.startOverlay.style.display = 'flex';
            memoryUI.numberDisplay.textContent = '';
            memoryUI.otpInputArea.classList.add('hidden');
            memoryUI.numberDisplay.classList.remove('hidden');
            memoryUI.timerDots.classList.add('invisible');
        }
        
        function runMemoryTest() {
             memoryUI.startOverlay.style.display = 'none';
            state.memoryTestResults = [];
            currentMemoryRound = 0;
            runMemoryRound();
        }

        function runMemoryRound() {
            currentMemoryRound++;
            memoryStartTime = 0;
            memoryUI.roundDisplay.textContent = `${currentMemoryRound} / ${AppConfig.MEMORY_ROUNDS}`;
            memoryUI.otpInputArea.classList.add('hidden');
            memoryUI.otpInputArea.innerHTML = '';
            memoryUI.numberDisplay.classList.remove('hidden');
            
            const numDigits = AppConfig.MEMORY_STARTING_DIGITS + (currentMemoryRound - 1) * AppConfig.MEMORY_DIGIT_INCREMENT;
            currentNumber = Array.from({ length: numDigits }, () => Math.floor(Math.random() * 10)).join('');
            
            memoryUI.numberDisplay.textContent = currentNumber.replace(/\B(?=(\d{3})+(?!\d))/g, "-");
            memoryUI.keyboardActivator.focus();
            
            const dots = memoryUI.timerDots.querySelectorAll('.timer-dot');
            dots.forEach(dot => dot.classList.remove('opacity-0'));
            memoryUI.timerDots.classList.remove('invisible');

            const totalDisplayTime = AppConfig.MEMORY_BASE_DISPLAY_TIME + numDigits * AppConfig.MEMORY_TIME_PER_DIGIT;
            const dotInterval = totalDisplayTime / dots.length;

            for (let i = 0; i < dots.length; i++) {
                setTimeout(() => {
                    const dotIndex = dots.length - 1 - i;
                    if (dots[dotIndex]) dots[dotIndex].classList.add('opacity-0');
                }, dotInterval * (i + 1));
            }
            setTimeout(() => {
                memoryUI.numberDisplay.classList.add('hidden');
                memoryUI.timerDots.classList.add('invisible');
                createOtpInputs(currentNumber.length);
            }, totalDisplayTime);
        }

        function createOtpInputs(count) {
            memoryUI.otpInputArea.innerHTML = '';
            for (let i = 0; i < count; i++) {
                if (i > 0 && i % 3 === 0) {
                    const dash = document.createElement('span');
                    dash.className = 'flex-shrink-0 w-4 flex items-center justify-center text-3xl md:text-4xl font-mono text-gray-400';
                    dash.textContent = '-';
                    memoryUI.otpInputArea.appendChild(dash);
                }
                const input = document.createElement('input');
                input.type = 'tel'; input.maxLength = 1; input.inputMode = 'numeric'; input.pattern = '[0-9]*';
                input.className = 'flex-1 min-w-0 max-w-[3rem] h-14 md:h-16 text-center text-2xl md:text-3xl font-mono border border-[#D7CEC5] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#6750A4]';
                input.addEventListener('input', handleOtpInput);
                input.addEventListener('keydown', handleOtpKeydown);
                memoryUI.otpInputArea.appendChild(input);
            }
            memoryUI.otpInputArea.classList.remove('hidden');
            const firstInput = memoryUI.otpInputArea.querySelector('input');
            if(firstInput) firstInput.focus();
        }

        function handleOtpInput(e) {
            if (memoryStartTime === 0) memoryStartTime = Date.now();
            const input = e.target;
            if (input.value.match(/^[0-9]$/)) {
                let next = input.nextElementSibling;
                if (next && next.tagName === 'SPAN') next = next.nextElementSibling;
                if (next) next.focus();
            }
        }

        function handleOtpKeydown(e) {
            const input = e.target;
            if (e.key === 'Backspace' && input.value === '') {
                let prev = input.previousElementSibling;
                if (prev && prev.tagName === 'SPAN') prev = prev.previousElementSibling;
                if (prev) prev.focus();
            } else if (e.key === ' ') {
                e.preventDefault();
                let next = input.nextElementSibling;
                if (next && next.tagName === 'SPAN') next = next.nextElementSibling;
                if (next) next.focus();
            } else if (e.key === 'Enter') {
                checkMemoryAnswer();
            }
        }

        function checkMemoryAnswer() {
            if (memoryUI.otpInputArea.dataset.checking === 'true') return;
            memoryUI.otpInputArea.dataset.checking = 'true';

            const allInputs = [...memoryUI.otpInputArea.children].filter(el => el.tagName === 'INPUT');
            const timeTaken = Date.now() - (memoryStartTime || Date.now());
            let correctDigits = 0;
            
            for (let i = 0; i < currentNumber.length; i++) {
                if (allInputs[i] && allInputs[i].value === currentNumber[i]) correctDigits++;
            }
            const accuracy = currentNumber.length > 0 ? (correctDigits / currentNumber.length) : 0;
            state.memoryTestResults.push({ speed: timeTaken, accuracy: accuracy, digits: currentNumber.length, correctDigits: correctDigits });

            setTimeout(() => {
                if (currentMemoryRound < AppConfig.MEMORY_ROUNDS) runMemoryRound();
                else endTest();
                memoryUI.otpInputArea.dataset.checking = 'false';
            }, 250);
        }

        // --- Jigsaw Puzzle Functions ---
        function startJigsawTest(isStandalone = false) {
            state.currentTest = 'jigsaw';
            state.inTestSession = !isStandalone;
            jigsawUI.backBtn.textContent = isStandalone ? 'Back to Menu' : 'Continue to Tests';

            const embedUrl = isStandalone 
                ? JIGSAW_EMBEDS[Math.floor(Math.random() * JIGSAW_EMBEDS.length)]
                : JIGSAW_EMBEDS[state.sessionCount];

            jigsawUI.embedContainer.innerHTML = '';
            
            const iframe = document.createElement('iframe');
            iframe.src = `${embedUrl}&_=${Date.now()}`; // Cache-busting to ensure a fresh puzzle load
            iframe.setAttribute('allow', 'web-share; fullscreen');
            iframe.setAttribute('aria-label', 'Puzzle Me Game');
            
            jigsawUI.embedContainer.appendChild(iframe);
            showScreen('jigsaw');
        }

        // --- General Test & Results Functions ---
        async function endTest() {
            const currentTestType = state.currentTest;

            if (currentTestType === 'aim') {
                const resultData = {
                    userName: state.userName, language: state.lang, group: state.group,
                    testType: currentTestType, timestamp: new Date().toISOString(),
                    results: state.aimTestResults,
                    musicCondition: state.currentMusicCondition,
                    musicLanguage: state.currentMusicLang,
                };
                await Database.saveResult(resultData);
                startMemoryTest();
                return;
            }

            if (currentTestType === 'memory') {
                Music.stop();
                const resultData = {
                    userName: state.userName, language: state.lang, group: state.group,
                    testType: currentTestType, timestamp: new Date().toISOString(),
                    results: state.memoryTestResults,
                    musicCondition: state.currentMusicCondition,
                    musicLanguage: state.currentMusicLang,
                };
                await Database.saveResult(resultData);
                
                state.sessionCount++;
                updateSessionCounter();
                
                showScreen('menu');
                if (state.sessionCount >= 3) {
                     alert("All test sessions are complete!");
                }
                state.inTestSession = false;
            }
        }

        async function showAllResults() {
            const results = await Database.getResults(state.userName, state.lang, state.group);
            let html = '<h3 class="text-2xl font-semibold text-center mb-4">Your History</h3>';
            
            const sessions = {};
            results.forEach(res => {
                if (!sessions[res.timestamp]) sessions[res.timestamp] = {};
                sessions[res.timestamp][res.testType] = res;
            });
            
            const sortedTimestamps = Object.keys(sessions).sort((a,b) => new Date(b) - new Date(a));

            if (sortedTimestamps.length === 0) {
                html += '<p class="text-center text-gray-500">No results found. Complete a test to see your history!</p>';
            } else {
                html += '<div class="space-y-6">';
                sortedTimestamps.forEach((ts, index) => {
                    const sessionData = sessions[ts];
                    const sessionNumber = sortedTimestamps.length - index;
                    const date = new Date(ts).toLocaleString();
                     html += `<div class="p-4 bg-gray-100 rounded-xl border-2">
                                <p class="font-bold text-xl text-center">Session ${sessionNumber}</p>
                                <p class="text-sm text-center text-gray-500 mb-2">${date}</p>`;
                    
                    if (sessionData.aim) {
                        const res = sessionData.aim;
                        const totalScore = res.results.reduce((a, r) => a + r.accuracy, 0);
                        const avgSpeed = (res.results.reduce((a, r) => a + r.speed, 0) / res.results.length).toFixed(2);
                        html += `<div class="p-3 bg-white rounded-lg border mt-2">
                                    <p class="font-semibold text-lg">Aim Trainer</p>
                                    <p class="mt-1">Avg. Speed: <span class="font-semibold">${avgSpeed} ms</span> | Score: <span class="font-semibold">${totalScore}/${AppConfig.AIM_TARGET_COUNT * 3}</span></p>
                                    <p class="text-sm text-gray-600">Music: ${res.musicLanguage} (${res.musicCondition})</p>
                                </div>`;
                    }
                    if (sessionData.memory) {
                        const res = sessionData.memory;
                        const totalCorrectDigits = res.results.reduce((acc, r) => acc + r.correctDigits, 0);
                        const totalDigitsShown = res.results.reduce((acc, r) => acc + r.digits, 0);
                        const overallAccuracy = (totalDigitsShown > 0 ? (totalCorrectDigits / totalDigitsShown * 100) : 0).toFixed(2);
                        html += `<div class="p-3 bg-white rounded-lg border mt-2">
                                    <p class="font-semibold text-lg">Number Memory</p>
                                    <p class="mt-1">Accuracy: <span class="font-semibold">${overallAccuracy}%</span> | Correct: <span class="font-semibold">${totalCorrectDigits} / ${totalDigitsShown}</span></p>
                                     <p class="text-sm text-gray-600">Music: ${res.musicLanguage} (${res.musicCondition})</p>
                                 </div>`;
                    }
                    html += `</div>`;
                });
                html += '</div>';
            }
            ui.resultsContent.innerHTML = html;
            showScreen('results');
        }

        function downloadCsv(results, baseFileName) {
            const headers = [
                "name", "language", "group", "test", "music_condition", "music_language", "aim_trial_round", "time_to_hit_aim", "time_to_hit_aim_cumulative", 
                "aim_score", "aim_score_cumulative", "total_possible_aim_score", "number_trial_round", 
                "time_to_enter_number", "time_to_enter_number_cumulative", "digits_correct", 
                "digits_correct_cumulative", "digits_this_round", "total_possible_correct_digits"
            ];
            let csvRows = [headers.join(',')];

            results.forEach(session => {
                if (session.testType === 'aim' && session.results) {
                    let timeCumulative = 0;
                    let scoreCumulative = 0;
                    
                    session.results.forEach((trial, index) => {
                        timeCumulative += trial.speed;
                        scoreCumulative += trial.accuracy;
                        const possibleScoreCumulative = (index + 1) * 3;
                        
                        const row = [
                            `"${session.userName}"`, session.language, session.group, session.testType, session.musicCondition, session.musicLanguage,
                            index + 1, trial.speed, timeCumulative, trial.accuracy, scoreCumulative, possibleScoreCumulative, 
                            'N/A', 'N/A', 'N/A', 'N/A', 'N/A', 'N/A', 'N/A'
                        ];
                        csvRows.push(row.join(','));
                    });
                } else if (session.testType === 'memory' && session.results) {
                    let timeCumulative = 0;
                    let correctCumulative = 0;
                    let totalDigitsCumulative = 0;

                    session.results.forEach((trial, index) => {
                        timeCumulative += trial.speed;
                        correctCumulative += trial.correctDigits;
                        totalDigitsCumulative += trial.digits;

                        const row = [
                           `"${session.userName}"`, session.language, session.group, session.testType, session.musicCondition, session.musicLanguage,
                           'N/A', 'N/A', 'N/A', 'N/A', 'N/A', 'N/A',
                           index + 1, trial.speed, timeCumulative, trial.correctDigits,
                           correctCumulative, trial.digits, totalDigitsCumulative
                        ];
                        csvRows.push(row.join(','));
                    });
                }
            });

            const csvContent = csvRows.join('\r\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${baseFileName}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function downloadMyCsv() {
            const results = await Database.getResults(state.userName, state.lang, state.group);
            downloadCsv(results, `${state.userName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_performance_data`);
        }

        async function downloadAllUserDataCsv() {
            const results = await Database.getAllResults();
            downloadCsv(results, 'all_users_performance_data');
        }

        window.addEventListener('DOMContentLoaded', async () => {
            await Database.init();
            setupEventListeners();
            showScreen('welcome');
        });
    </script>
</body>
</html>

